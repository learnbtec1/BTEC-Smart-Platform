# ================================
# BTEC Smart Platform - One Shot Fix
# ุชุนุฏูู .env + ุชุดุบูู Docker
# ================================

# 1) ุงููุณุงุฑ ุงูุฃุณุงุณู ูููุดุฑูุน
$projectRoot = "D:\BTEC-backend"
$envFile     = Join-Path $projectRoot ".env"
$backupFile  = Join-Path $projectRoot ".env.backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"

Write-Host "๐ ุงููุดุฑูุน: $projectRoot"
Write-Host "๐ ููู env: $envFile"
Write-Host ""

# 2) ุชุฃููุฏ ูุฌูุฏ ุงูููู
if (-not (Test-Path $envFile)) {
    Write-Host "โ ููู .env ุบูุฑ ููุฌูุฏ ูู: $envFile" -ForegroundColor Red
    exit 1
}

# 3) ุฃุฎุฐ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู .env
Copy-Item $envFile $backupFile -Force
Write-Host "โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ: $backupFile"
Write-Host ""

# 4) ุชุญููู ูุญุชูู .env
$content = Get-Content $envFile

# 5) ุงุณุชุจุฏุงู ููู JWT_SECRET_KEY ู SECRET_KEY ูุชุฑู API_KEY ููุง ูู
$newJwt  = "JWT_SECRET_KEY=4e9f2a7c1d3b8f6a9c2d5e7b3a1f6c8d"
$newSec  = "SECRET_KEY=8f2c4a1d9e7b3c6f4d8a2b1c3e5f7a9d"

# ุงุณุชุจุฏุงู ุงูุณุทูุฑ ุงูุชู ุชุจุฏุฃ ุจูุฐู ุงูููุงุชูุญ
$content = $content -replace "^JWT_SECRET_KEY=.*", $newJwt
$content = $content -replace "^SECRET_KEY=.*",    $newSec

# 6) ุฅุฒุงูุฉ STACK_NAME ูุฃูู ูู ูุนุฏ ูุณุชุฎุฏููุง
$content = $content -replace "^STACK_NAME=.*", "# STACK_NAME (removed - no longer used)"

# 7) ุญูุธ .env ุจุนุฏ ุงูุชุนุฏูู
Set-Content -Path $envFile -Value $content -Encoding UTF8
Write-Host "โ ุชู ุชุญุฏูุซ ููู JWT_SECRET_KEY ู SECRET_KEY ูู .env"
Write-Host ""

# 8) ุงูุงูุชูุงู ููุฌูุฏ ุงููุดุฑูุน ูุชุดุบูู Docker
Set-Location $projectRoot

Write-Host "๐ณ ุฅููุงู ุฃู ุญุงููุงุช ุณุงุจูุฉ..." -ForegroundColor Yellow
docker compose down

Write-Host ""
Write-Host "๐ณ ุจูุงุก ูุชุดุบูู ุงูุญุงููุงุช ูู ุฌุฏูุฏ..." -ForegroundColor Yellow
docker compose up --build